apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "rabbitmq.fullname" . }}-scripts
  labels:
    {{- include "rabbitmq.labels" . | nindent 4 }}
data:
  init.sh: |
    #!/bin/sh
    echo "Initializing RabbitMQ instance..."
    echo "Copy configuration"
    cp /temp/rabbitmq/* /etc/rabbitmq
    if [ -d /extraconfigs ]; then
      echo "Add extra configs to rabbitmq config"
      cat /extraconfigs/* >>/etc/rabbitmq/rabbitmq.conf
    fi
    if [ -d /extraadvancedconfigs ]; then
      echo "Add extra advanced configs to rabbitmq advanced config"
      cat /extraadvancedconfigs/* >>/etc/rabbitmq/advanced.conf
    fi
    if [ -d /temp/plugins ]; then
      echo "Copy plugin configuration"
      cp /temp/plugins/* /etc/rabbitmq
    else
      echo "No plugins configured."
    fi
    mkdir -p /etc/rabbitmq/conf.d
    if [ ! -f /var/lib/rabbitmq/.erlang.cookie ]; then
      echo "Copy erlang cookie"
      echo $ERLANG_COOKIE >/var/lib/rabbitmq/.erlang.cookie
    else
      echo "Erlang cookie already exists."
    fi
    chmod 600 /var/lib/rabbitmq/.erlang.cookie
    echo "Finished."
